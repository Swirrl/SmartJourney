<div class="sixteen" id="filters">
  <%= form_tag reports_path, :method => 'get' do %>
    <h3 style="float:left">Filters</h3>
    <%= image_tag 'loading-spinner.gif', :class => 'loading-spinner', :style => 'display:none; float:left; margin: 10px 10px 0 10px' %>
    <br style="clear:both" />

    <div class="planned-filter">
      <%= radio_button_tag 'future', 'false', !@future, :style => 'margin-top:-2px' %> Current
      &nbsp;
      <%= radio_button_tag 'future', 'true', @future, :style => 'margin-top:-2px'  %> Planned
    </div>

    <div class="zones-filter">
      <% if current_user %>
        <%= check_box_tag 'selected_zones_only', 'true', @selected_zones_only, :style => 'margin-top:-2px'  %> Show only reports in your <%= link_to "chosen zones", edit_user_registration_path %>.
      <% else %>
        <%= link_to 'Sign in', new_user_session_path %> to filter reports by your chosen geographic zones. <br/>
      <% end %>
    </div>

    <div class="tags-filter">
      <%= label_tag do %>
       <%= image_tag "icon-tag.png" %> show reports with any of these tags:
      <% end %>
      <%= text_field_tag 'tags', @tags_string %>
      <%= render 'popular_tags' %>
      <%= render 'tagsjs', :tag_field_id => "tags" %>
    </div>

    <%= submit_tag 'Apply filters' %>
  <% end %>

</div>

<script type="text/javascript">
  $(function() {

    function ajaxError() {
      alert('There was an error applying your filters. Please try again.');
    }

    function showSpinner() {
      $('#filters img.loading-spinner').show()
    }

    function hideSpinner() {
      $('#filters img.loading-spinner').hide()
    }

    $('#filters').ajaxStart(showSpinner);
    $('#filters').ajaxStop(hideSpinner);
    $('#filters').ajaxError(ajaxError)

    function filtersChanged() {

      // need to get new list of reports and update the map
      var url = '<%= reports_url %>' + '?' + $('#filters form').serialize();

      // update the map.
      $.ajax( {
        url: url,
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          SmartJourney.feedMap.updateReports(data);
        }
      });

      // update the reports feed too.
      $.ajax( {
        url: url,
        dataType: 'script' // will be interpreted as js (calls index.js.erb)
      });

    }

    // hide the submit btn
    $('#filters input[type="submit"]').hide();
    $('#filters input[type="checkbox"], #filters input[type="radio"]').change(function() {
      filtersChanged();
    });

    var tagField = $('#tags');
    tagField.tagit({
      afterTagAdded: function(event, ui) {
        filtersChanged();
      },
      afterTagRemoved: function(event, ui) {
        filtersChanged();
      }
    });

  });
</script>